<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Python IDE</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/python-hint.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/hint/show-hint.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/lint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/javascript-lint.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/lint/lint.min.css">
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      font-family: monospace;
      background: #0f172a;
      color: #e5e7eb;
    }
    #sidebar{
      width:220px;
      background:#020617;
      border-right:1px solid #1e293b;
      padding:8px;
      overflow-y:auto;
    }
    .file-item{
      padding:6px;
      cursor:pointer;
      border-radius:6px;
    }
    .file-item:hover{ background:#1e293b; }
    .file-item.active{ background:#2563eb; }

    #editor-container {
      flex: 1;
      height: 100vh;
      padding: 10px;
      display: flex;
      flex-direction: column;
    }
    #tabs{ display:flex; gap:6px; margin-bottom:6px; }
    .tab{
      padding:4px 8px;
      border-radius:6px;
      background:#1e293b;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{ background:#2563eb; }
    .CodeMirror {
      height: 100% !important;
      font-size: 13px;
      border-radius: 12px;
      overflow: auto; /* enable scroll */
      white-space: pre;
      flex: 1;
    }
    #right {
      width: 360px;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #controls {
      position: relative;
      padding: 8px;
      border-bottom: 1px solid #1e293b;
    }
    #settingsBtn {
      background: #2563eb;
      border-radius: 6px;
      color: white;
      padding: 6px 10px;
      cursor: pointer;
      border: none;
    }
    #runBtn {
      background: #2563eb;
      border-radius: 6px;
      color: white;
      padding: 6px 10px;
      cursor: pointer;
      border: none;
    }
    #dropdown {
      display: none;
      position: absolute;
      top: 40px;
      left: 0;
      background: #1e293b;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 6px;
      flex-direction: column;
      z-index: 1000;
    }
    #dropdown button {
      background: #2563eb;
      margin: 2px 0;
      border-radius: 4px;
      cursor: pointer;
      padding: 6px 10px;
      color: white;
      border: none;
    }
    #output { flex: 1; white-space: pre-wrap; overflow-y: auto; padding: 10px; border-radius:12px; background: #020617; }
    .error-line {
      background: rgba(255, 80, 80, 0.25);
      text-decoration: underline;
      text-decoration-color: #ef4444;
    }
    #filePage {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #0f172a;
      color: #e5e7eb;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    .status-message {
      color: #9ca3af; /* grey color */
    }
    #output input[type="text"] {
      background: #020617;
      border: 1px solid #2563eb;
      color: #e5e7eb;
      font-family: monospace;
      font-size: 15px;
      padding: 2px 6px;
      margin: 0;
      border-radius: 6px;
      width: 90%;
      outline: none;
    }
    /* Custom Python syntax highlighting */
    .cm-bracket { color: #facc15 !important; }        /* yellow brackets */
    .cm-variable { color: #38bdf8 !important; }       /* variables blue */
    .cm-variable-2 { color: #22c55e !important; }     /* builtins / secondary */
    .cm-string { color: #22c55e !important; }         /* strings green */
    .cm-number { color: #fb923c !important; }         /* integers orange */
    .cm-keyword { color: #a855f7 !important; }        /* if / for / while purple */
    .cm-operator { color: #ffffff !important; }       /* arithmetic operators white */
    .cm-def { color: #eab308 !important; }             /* function names */
    .cm-comment { color: #94a3b8 !important; }        /* comments muted for txt files */
    .cm-atom { color: #f472b6 !important; } /* True / False / None */
    .cm-error {
      text-decoration: underline;
      text-decoration-color: #ef4444;
      text-decoration-thickness: 2px;
    }
    .cm-builtin { color: #e7d3a1 !important; }  /* print */
    .cm-keyword.cm-import { color: #e7d3a1 !important; } /* import */
    .CodeMirror-lint-message-error {
      background: #020617;
      color: #ef4444;
    }
    .CodeMirror-lint-marker-error {
      background: #ef4444;
    }
    .cm-lintRange-error {
      text-decoration: underline;
      text-decoration-color: #ef4444;
      text-decoration-style: wavy;
      text-decoration-thickness: 2px;
    }
    .cm-bracket-mismatch {
      text-decoration: underline;
      text-decoration-style: wavy;
      text-decoration-color: #ef4444;
    }
  </style>
</head>
<body>

  <div id="sidebar">
    <div id="fileTree"></div>
    <div style="margin-top:10px; border-top:1px solid #1e293b; padding-top:8px;">
      <button onclick="createTxtFile()" style="width:100%;">Create .txt</button>
    </div>
  </div>

  <div id="editor-container">
    <div id="tabs"></div>
    <div id="editorHeader" style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">
      <img src="https://upload.wikimedia.org/wikipedia/commons/c/c3/Python-logo-notext.svg" style="width:20px; height:20px;" />
      <span style="font-weight:bold;" id="currentFileName">main.py</span>
    </div>
    <textarea id="editor"></textarea>
  </div>

    <div id="right">
      <div id="controls">
        <button id="runBtn">‚ñ∂</button>
        <button id="settingsBtn">‚öôÔ∏è</button>
        <div id="dropdown">
          <button onclick="saveFile()">Save üíæ</button>
          <button onclick="loadFile()">Load üìÇ</button>
          <button id="toggleSidebarBtn">Toggle Sidebar</button>
        </div>
        <span id="status">Loading Python...</span>
        <input type="file" id="fileInput" style="display:none" />
      </div>
      <div id="output"></div>
    </div>

<script>
let pyodide;
let ready = false;

const files = {};
let currentFile = null;

const editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
  mode: "python",
  theme: "dracula",
  lineNumbers: true,
  indentUnit: 4,
  tabSize: 4,
  styleActiveLine: true,
  matchBrackets: true,
  autoCloseBrackets: true,
  highlightSelectionMatches: true,
  lint: true,
  gutters: ["CodeMirror-linenumbers", "CodeMirror-lint-markers"],
  lineWrapping: true,
  viewportMargin: Infinity,
});

/* Ensure editor always remains editable */
editor.setOption("readOnly", false);
editor.setOption("cursorBlinkRate", 530);

/* Keep file contents synced with editor so code can be edited and run repeatedly */
editor.on("change", () => {
  if (currentFile) {
    files[currentFile] = editor.getValue();
  }
});

function openFile(name, content){
  files[name] = content;
  currentFile = name;
  editor.setValue(content);
  editor.setOption('mode','python');
  document.getElementById('currentFileName').textContent = name;
  renderTabs();
  renderFileTree();
}

function renderTabs(){
  const t = document.getElementById('tabs');
  t.innerHTML='';
  Object.keys(files).forEach(f=>{
    const d=document.createElement('div');
    d.className='tab'+(f===currentFile?' active':'');
    d.textContent=f;
    d.onclick=()=>{
      files[currentFile]=editor.getValue();
      currentFile=f;
      editor.setValue(files[f]);
      editor.setOption('mode','python');
      document.getElementById('currentFileName').textContent = f;
      renderTabs();
      renderFileTree(); // <- ensure sidebar updates
    };
    t.appendChild(d);
  });
}

function renderFileTree(){
  const ft=document.getElementById('fileTree');
  ft.innerHTML='';
  Object.keys(files).forEach(f=>{
    const d=document.createElement('div');
    d.className='file-item'+(f===currentFile?' active':'');
    d.style.display='flex';
    d.style.justifyContent='space-between';
    d.style.alignItems='center';

    const span=document.createElement('span');
    span.textContent=f;
    span.style.cursor='pointer';
    span.onclick=()=>{
      files[currentFile]=editor.getValue();
      currentFile=f;
      editor.setValue(files[f]);
      editor.setOption('mode','python');
      document.getElementById('currentFileName').textContent = f;
      renderTabs();
      renderFileTree();
    };
    d.appendChild(span);

    if(f !== 'main.py'){
      const menuBtn=document.createElement('span');
      menuBtn.textContent='‚ãÆ';
      menuBtn.style.cursor='pointer';
      menuBtn.onclick=(e)=>{
        e.stopPropagation();
        const existing=document.getElementById('fileMenu');
        if(existing) existing.remove();
        const menu=document.createElement('div');
        menu.id='fileMenu';
        menu.style.position='absolute';
        menu.style.background='#1e293b';
        menu.style.border='1px solid #333';
        menu.style.padding='4px';
        menu.style.borderRadius='4px';
        const delBtn=document.createElement('button');
        delBtn.textContent='Delete';
        delBtn.onclick=()=>{
          if(confirm(`Delete ${f}?`)){
            delete files[f];
            if(currentFile===f){
              currentFile='main.py';
              editor.setValue(files['main.py']);
            }
            renderTabs();
            renderFileTree();
          }
          menu.remove();
        };
        menu.appendChild(delBtn);
        document.body.appendChild(menu);
        const rect=menuBtn.getBoundingClientRect();
        menu.style.left=rect.right+'px';
        menu.style.top=rect.top+'px';
      };
      d.appendChild(menuBtn);
    }

    ft.appendChild(d);
  });
}

openFile('main.py','');

editor.on("cursorActivity", () => {
  editor.getAllMarks().forEach(m => {
    if(m.className === 'cm-bracket-mismatch') m.clear();
  });
  const cur = editor.getCursor();
  const tok = editor.getTokenAt(cur);
  if(tok.type === 'bracket'){
    const match = editor.findMatchingBracket(cur);
    if(!match || !match.match){
      editor.markText(
        { line: cur.line, ch: tok.start },
        { line: cur.line, ch: tok.end },
        { className: 'cm-bracket-mismatch' }
      );
    }
  }
});

// Show lines in output corresponding to code lines
function appendOutputLine(text, isStatus=false){
  const out = document.getElementById('output');
  const span = document.createElement('span');
  if(isStatus) span.className='status-message';
  span.textContent = text;
  out.appendChild(span);
  out.appendChild(document.createElement('br'));
  out.scrollTop = out.scrollHeight;
}

// Append text inline (without line break)
function appendOutputInline(text){
  const out = document.getElementById('output');
  if(out.lastChild && out.lastChild.nodeType === Node.TEXT_NODE){
    out.lastChild.textContent += text;
  } else if(out.lastChild && out.lastChild.tagName === 'SPAN'){
    out.lastChild.textContent += text;
  } else {
    const span = document.createElement('span');
    span.textContent = text;
    out.appendChild(span);
  }
  out.scrollTop = out.scrollHeight;
}

// Settings dropdown toggle
document.getElementById('settingsBtn').addEventListener('click', ()=>{
  const dd = document.getElementById('dropdown');
  dd.style.display = dd.style.display==='flex'?'none':'flex';
});

editor.addKeyMap({
  "Ctrl-Enter": () => runCode(),
});

async function runCode(){
  const startTime = performance.now();
  if(currentFile) files[currentFile] = editor.getValue();
  const out = document.getElementById('output');
  out.textContent = '';
  appendOutputLine('Running code...', true);
  editor.getAllMarks().forEach(m=>m.clear());
  if(!ready) return;

  let txtVars = '';
  Object.keys(files).forEach(f=>{
    if(f.endsWith('.txt')){
      const varName = f.replace(/\.txt$/,'').replace(/\W/g,'_');
      txtVars += `${varName} = """${files[f]}"""\n`;
    }
  });

  const userCode = files['main.py'] || '';

  // Build Python code
  const code = `
import sys
from io import StringIO
import builtins
import js

buffer = StringIO()
sys.stdout = buffer
sys.stderr = buffer

# Use standard prompt() for input and echo prompt + value to output
def input(prompt=""):
    val = js.prompt(prompt)
    if val is None:
        val = ""
    if prompt:
        print(prompt, end="")
    print(val)
    return val

builtins.input = input

# Inject txt variables
${txtVars.split('\n').map(line => line ? line : '').join('\n')}

# User code
${userCode}

buffer.getvalue()
`;

  try{
    let outputBuffer = await pyodide.runPythonAsync(code);
    if(!outputBuffer) outputBuffer = '';
    outputBuffer = String(outputBuffer);
    outputBuffer.split('\n').forEach(line => appendOutputLine(line));
  } catch(err){
    appendOutputLine(err.toString());
    const match = err.toString().match(/line (\d+)/);
    if(match){
      const line = parseInt(match[1],10)-1;
      if(err.toString().startsWith('SyntaxError')){
        const colMatch = err.toString().match(/column (\d+)/);
        if(colMatch){
          const ch = Math.max(0, parseInt(colMatch[1],10)-1);
          editor.markText({ line, ch }, { line, ch: ch + 1 }, { className: 'cm-error' });
        }
      } else {
        editor.markText({line,ch:0},{line,ch:editor.getLine(line).length},{className:'error-line'});
      }
    }
  }

  const elapsed = ((performance.now() - startTime)/1000).toFixed(3);
  appendOutputLine(`Finished in ${elapsed} seconds`, true);
  /* Return focus to editor so user can keep editing and rerunning */
  editor.focus();
}

function saveFile(){
  const blob = new Blob([editor.getValue()], {type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=currentFile || 'script.py';
  a.click();
}
function loadFile(){ document.getElementById('fileInput').click(); }
document.getElementById('fileInput').addEventListener('change', e=>{
  const file=e.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{
    openFile(file.name,reader.result);
  };
  reader.readAsText(file);
});

async function loadPython(){
  pyodide=await loadPyodide();
  ready=true;
  document.getElementById('status').textContent='Python ready';
}
loadPython();

// Add Run button event listener
document.getElementById('runBtn').addEventListener('click', runCode);


function createTxtFile(){
  const name = prompt("Enter new .txt file name:", "newfile.txt");
  if(name && name.endsWith('.txt')){
    openFile(name, "");
    appendOutputLine(`Created ${name}`, true);
  } else if(name){
    alert("File name must end with .txt");
  }
}

document.body.addEventListener('dragover',e=>e.preventDefault());
document.body.addEventListener('drop',e=>{
  e.preventDefault();
  [...e.dataTransfer.files].forEach(file=>{
    const reader=new FileReader();
    reader.onload=()=>openFile(file.name,reader.result);
    reader.readAsText(file);
  });
});
// --- Python hints toggle ---
let hintsEnabled = true;
function inputHintListener(cm, change) {
  if(change.text[0].match(/[a-zA-Z_]/)){
    cm.showHint({hint: CodeMirror.hint.python, completeSingle: false});
  }
}
// attach initially
editor.on("inputRead", inputHintListener);

</script>
<script>
// Sidebar toggle button functionality
document.getElementById('toggleSidebarBtn').addEventListener('click', () => {
  const sidebar = document.getElementById('sidebar');
  if(sidebar.style.display === 'none') {
    sidebar.style.display = 'block';
  } else {
    sidebar.style.display = 'none';
  }
});
</script>
</body>
</html>

